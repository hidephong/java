<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
    <head>
        <title>Setting Privileges for Extensions (The Java&trade; Tutorials &gt; 
            The Extension Mechanism &gt; Making Extensions Secure)
</title>
<style type="text/css">
    .FigureCaption   { 
        margin-left: 1in; 
        margin-right: 1in; 
        font-family: sans-serif; 
        font-size: smaller; 
        text-align: justify;
    }
    #TopBar_bl {
        background: url(../../images/java_bar_bl.gif) 0 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_br {
        background: url(../../images/java_bar_br.gif) 100% 100% no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tl {
        background: url(../../images/java_bar_tl.gif) 0 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar_tr {
        background: url(../../images/java_bar_tr.gif) 100% 0 no-repeat;
        width: 100%;
        height: 60px;
    }
    #TopBar {
        background: #35556B url(../../images/java_bar.gif);
        margin: 10px 10px 0 10px;
        height:60px;
        min-width:700px;
        color: white;
        font-family: sans-serif; 
        font-weight: bold;
    }
    @media print {
        #BreadCrumbs, #Download {
            display: none;
        }
    }
    #TopBar_right {
        line-height: 14px;
        float: right;
        padding-top: 2px;
        padding-right: 30px;
        text-align: center;
    }
    @media print {
        #TopBar_right {
            display: none;
        }
    }
    #TopBar_right a {
        font-size: 12px;
        margin: 3px;
        padding: 0;
    }
    #TopBar a:visited, #TopBar a:link {
        color: white;
        text-decoration: none;
    }
    #TopBar a:hover, #TopBar a:active  {
        background-color: white;
        color: #35556B;
    }
    #BreadCrumbs {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
        float: right;
    }
    #BreadCrumbs a {
        color: blue;
    }
    #BreadCrumbs a:visited, #BreadCrumbs a:link {
        text-decoration: none;
    }
    #BreadCrumbs a:hover, #BreadCrumbs a:active {
        text-decoration: underline;
    }
    #PageTitle {
        margin: 0 5px 0.5em 0;
        color: #E76F00;
        font-family: sans-serif; 
        font-weight: bold;
        font-size: 20px;
    }
    .LeftBar_shown {
        width: 13em;
        float: left;
        margin-left: 10px;
        margin-top: 4px;
        margin-bottom: 2em;
    }
    @media print {
        .LeftBar_shown {
            display: none;
        }
    }
    .LeftBar_hidden {
        display: none;
    }
    #Footer {
        padding-top: 10px;
        padding-left: 10px;
        margin-right: 10px;
    }
    .NavBit  {
        padding: 4px 5px 0.5em 0;
        font-family: sans-serif; 
    }
    @media print {
        .NavBit {
            display: none;
        }
    }
    #TagNotes {
        text-align: right;
        font-size: smaller;
        font-family: sans-serif; 
    }
    @media print {
        #TagNotes a:visited, #TagNotes a:link {
            color: #35556B;
            text-decoration: none;
        }
    }
    #Contents a, .NavBit a, #TagNotes a {
        color: blue
    }
    #TagNotes a:visited, #TagNotes a:link,
    #Contents a:visited, #Contents a:link,
    .NavBit a:visited, .NavBit a:link {
        text-decoration: none;
    }
    #TagNotes a:hover, #TagNotes a:active,   
    #Contents a:hover, #Contents a:active,   
    .NavBit a:hover, .NavBit a:active {  
        text-decoration: underline;
    }
    #Contents {
        float: left;
        font-family: sans-serif; 
    }
    @media print {
        #Contents {
            display: none;
        }
    }
    @media screen {
        div.PrintHeaders {
            display: none;
        }
    }
    .linkLESSON, .nolinkLESSON {
        margin-left: 0.5em;
        text-indent: -0.5em
    }
    .linkAHEAD, .nolinkAHEAD, .linkQUESTIONS, .nolinkQUESTIONS   {
        margin-left: 1.5em; 
        text-indent: -0.5em
    }
    .linkBHEAD, .nolinkBHEAD   {
        margin-left: 2.5em;
        text-indent: -0.5em
    }
    .linkCHEAD, .nolinkCHEAD   {
        margin-left: 3.5em;
        text-indent: -0.5em
    }
    .nolinkLESSON, .nolinkAHEAD, .nolinkBHEAD, .nolinkCHEAD,
    .nolinkQUESTIONS {
        font-weight: bold;
        color: #E76F00;
    }
    .MainFlow_indented {
        margin-right: 10px;
        margin-left: 15em;
        margin-bottom: 2em;

    }
    .MainFlow_wide {
        margin-right: 10px;
        margin-left: 10px;
        margin-bottom: 2em;

    }
    @media print {
        .MainFlow_indented, .MainFlow_wide {
            padding-top: 0;
            margin-top: 10px;
            margin-right: 10px;
            margin-left: 0;
        }
    }
    h3, h4, h5 {
        color: #E76F00;
        font-family: sans-serif;
    }
    #ToggleLeft {
        display: none;
    }

    /t

</style>
<script type="text/javascript">
    function leftBar() {
        var nameq = 'tutorial_showLeftBar='
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookieString = cookies[i];
            while (cookieString.charAt(0) == ' ') {
                cookieString = cookieString.substring(1, cookieString.length);
            }
            if (cookieString.indexOf(nameq) == 0) {
                cookieValue =  cookieString.substring(nameq.length,
                        cookieString.length);
                return cookieValue == 'yes';
            }
        }
        return true;
    }

    function showLeft(b) {
        var contents = document.getElementById("LeftBar");
        var main = document.getElementById("MainFlow");
        var toggle = document.getElementById("ToggleLeft");
        if (b) {
            contents.className = "LeftBar_shown";
            main.className = "MainFlow_indented";
            toggle.innerHTML = "Hide the TOC";
            document.cookie = 'tutorial_showLeftBar=yes; path=/';
        } else {
            contents.className = "LeftBar_hidden";
            main.className = "MainFlow_wide";
            toggle.innerHTML = "Show the TOC";
            document.cookie = 'tutorial_showLeftBar=no; path=/';
        }
    }

    function toggleLeft() {
        showLeft(document.getElementById("LeftBar").className ==
                "LeftBar_hidden");
        document.getElementById("ToggleLeft").blur();
    }

    function load() {
        showLeft(leftBar());
        document.getElementById("ToggleLeft").style.display="inline";
    }
    
</script>

    </head>
<body onload="load()">
    <div id=TopBar> <div id=TopBar_tr> <div id=TopBar_tl> <div id=TopBar_br> <div id=TopBar_bl> 
                        <div id=TopBar_right> 
                            <a target="_blank"
                                href="http://java.sun.com/javase/6/download.jsp">Download
                                the JDK</a>
                            <br>
                            <a href="../../search.html" target="_blank">Search the
                                Tutorials</a>
                            <br>
                            <a href="javascript:toggleLeft()"
                                id="ToggleLeft">Hide the TOC</a>
                        </div>
                    </div> </div> </div> </div> </div>
    <div class=PrintHeaders>
        <b>Trail:</b> The Extension Mechanism
        <br><b>Lesson:</b> Making Extensions Secure
    </div>

    <div id=LeftBar class=LeftBar_shown>
        <div id=Contents>
            <div class="linkLESSON"><a href="index.html">Making Extensions Secure</a></div>
<div class="nolinkAHEAD">Setting Privileges for Extensions</div>
<div class="linkAHEAD"><a href="sealing.html">Sealing Packages in Extensions</a></div>
</div>
    </div>
    <div id=MainFlow class=MainFlow_indented>
            <span id=BreadCrumbs>
                <a href=../../index.html target=_top>Home Page</a>
                &gt;
                <a href=../index.html target=_top>The Extension Mechanism</a>
                &gt;
                <a href=index.html target=_top>Making Extensions Secure</a>
            </span>
            <div class=NavBit>
                <a target=_top href=index.html>&laquo;&nbsp;Previous</a>&nbsp;&bull;&nbsp;<a target=_top href=../TOC.html>Trail</a>&nbsp;&bull;&nbsp;<a target=_top href=sealing.html>Next&nbsp;&raquo;</a>
            </div>
            <div id=PageTitle>Setting Privileges for Extensions</div>
            <blockquote>
If a
<a class="TutorialLink" target="_top" href="../../essential/environment/security.html">security manager</a> is in force, the following conditions must be met to 
enable any software, including extension software, to perform 
security-sensitive operations:
<ul>
<li>The security-sensitive code in the extension must be wrapped 
in a <code>PrivilegedAction</code> object.
<li>The security policy implemented by the security manager must 
grant the appropriate permission to the extension. By default, 
installed extensions are granted all security permissions as if 
they were part of the core platform API. The permissions 
granted by the security policy apply only to code wrapped in the 
<code>PrivilegedAction</code> instance.
</ul>
<p>
Let's look at each of these conditions in a little more detail, with 
some examples.
<p>
</blockquote>
<h3>Using the PrivilegedAction Class</h3>
<blockquote>
Suppose that you want to modify the <code>RectangleArea</code> class in the 
extension example of the previous 
lesson to write rectangle areas to a file rather than to 
stdout.  Writing to a file, however, is a security-sensitive 
operation, so if your software is going to be running under a 
security manager, you'll need to mark your code as being privileged. 
There are two steps you need to take to do so:
<ol>
<li>You need to place code that performs security-sensitive operations 
within the <code>run</code> method of an object of type 
<code>java.security.PrivilegedAction</code>.
<li>You must use that <code>PrivilegedAction</code> object as the 
argument in a call to the <code>doPrivileged</code> method of 
<code>java.security.AccessController</code>.
</ol>
<p>
If we apply those guidelines to the <code>RectangleArea</code> class, 
our class definition would look something like this:
<blockquote><pre>
import java.io.*;
import java.security.*;

public final class RectangleArea {
    public static void writeArea(final java.awt.Rectangle r) {
        AccessController.doPrivileged(new PrivilegedAction() {
	    public Object run() {
	        try { 
		    int area = r.width * r.height;
                    String userHome = System.getProperty("user.home");
		    FileWriter fw = new FileWriter(
                        userHome + File.separator
                        + "test" + File.separator
                        + "area.txt");
		    fw.write("The rectangle's area is " + area);
		    fw.flush();
		    fw.close();
	        } catch(IOException ioe) {
		    System.err.println(ioe);
	        }
	        return null;
	    }
        });
    }
}
</pre></blockquote>
<p>
The single method in this class, <code>writeArea</code>, computes the 
area of a rectangle, and writes the area to a file called 
<code>area.txt</code> in the <code>test</code> directory under the user's home
directory.
<p>
The security-sensitive statements dealing with the output file are 
placed within the <code>run</code> method of a new instance of 
<code>PrivilegedAction</code>. (Note that <code>run</code> requires that an 
<code>Object</code> instance be returned. The returned object can be 
<code>null</code>.) The new <code>PrivilegedAction</code> 
instance is then passed as an argument in a call to 
<code>AccessController.doPrivileged</code>. 

<p>
For more information about using <code>doPrivileged</code>, see 

<a class="OutsideLink" target="_blank" href="http://java.sun.com/javase/6/docs/guide/security/doprivileged.html">API for Privileged Blocks</a>  in the JDK<font size="-2"><sup>TM</sup></font> documentation.

<p>
Wrapping security-sensitive code in a <code>PrivilegedAction</code> 
object in this 
manner is the first requirement for enabling an extension to perform 
security-sensitive operations. 
The second requirement is: getting the security manager 
to grant the privileged code the appropriate permissions.
</blockquote>

<h3>Specifying Permissions with the Security Policy</h3>
<blockquote>
The security policy in force at runtime is specified by a 
<em>policy file</em>.  The default  
policy is set by the file <code>lib/security/java.policy</code> in 
the JRE software.
<p>
The policy file assigns security privileges to software by using 
<em>grant</em> entries. The policy file can contain any number of 
grant entries. The default policy file has 
this grant entry for installed extensions:
<blockquote><pre>
grant codeBase "file:${{java.ext.dirs}}/*" {
    permission java.security.AllPermission;
};
</pre></blockquote>
This entry specifies that files in the directories specified by
<code>file:${{java.ext.dirs}}/*</code> are to be granted the permission called 
<code>java.security.AllPermission</code>.

(Note that as of Java 6, <code>java.ext.dirs</code> refers to a
<tt>classpath</tt>-like path of directories, each of which can hold installed
extensions.)

It's not too hard to guess that <code>java.security.AllPermission</code> 
grants installed extensions all the security privileges that it's possible 
to grant. 
<p>
By default, then, installed extensions have no security restrictions.  
Extension software can perform security-sensitive operations as if there were 
no security manager installed, provided that security-sensitive code 
is contained in an instance of <code>PrivilegedAction</code> passed as an 
argument in a <code>doPrivileged</code> call. 
<p>
To limit the privileges granted to extensions, you need to 
modify the policy file. To deny all privileges to all extensions, 
you could simply remove the above grant entry.
<p>
Not all permissions are as comprehensive as the 
<code>java.security.AllPermission</code> granted by default. After 
deleting the default grant entry, you can enter a new grant entry 
for particular permissions, including:
<ul> 
<li><code>java.awt.<b>AWTPermission</b></code>
<li><code>java.io.<b>FilePermission</b></code>
<li><code>java.net.<b>NetPermission</b></code> 
<li><code>java.util.<b>PropertyPermission</b></code>
<li><code>java.lang.reflect.<b>ReflectPermission</b></code>
<li><code>java.lang.<b>RuntimePermission</b></code>
<li><code>java.security.<b>SecurityPermission</b></code>
<li><code>java.io.<b>SerializablePermission</b></code>
<li><code>java.net.<b>SocketPermission</b></code>
</ul>
<p>
The 
<a class="OutsideLink" target="_blank" href="http://java.sun.com/javase/6/docs/guide/security/permissions.html">Permissions in the JDK</a> documentation provides details about each of these
permissions.

Let's look at those needed to use RectangleArea as an extension.
<p>
The <code>RectangleArea.writeArea</code> method 
needs two permissions: one to determine the path to the user's home directory,
and the other to write to a file.

Assuming that the 
<code>RectangleArea</code> class is bundled in the file 
<code>area.jar</code>, you could grant write privileges by adding 
this entry to the policy file:
<blockquote><pre>
grant codeBase "file:${java.home}/lib/ext/area.jar" {
    permission java.io.PropertyPermission "user.home", "read";
    permission java.io.FilePermission "${user.home}${/}test${/}*", "write";
};
</pre></blockquote>
The <code>codeBase&nbsp;"file:${java.home}/lib/ext/area.jar"</code> part 
of this 
entry guarantees that any permissions specified by this entry will 
apply only to the <code>area.jar</code>.

The <code>java.io.PropertyPermission</code> permits access to properties.

The first argument, <code>"user.home"</code>, names the property, and
the second argument, <code>"read"</code>, indicates that the property can be
read.

(The other choice is <code>"write"</code>.)

<p>

The <code>java.io.FilePermission</code> 
permits access to files.

The first argument, <code>"${user.home}${/}test${/}*"</code>, 
indicates that <code>area.jar</code> is being granted permission to 
access all files in the <code>test</code> directory that is in the user's home
directory.  (Note that <code>${/}</code> is a platform-independent file
separator.)

The second argument indicates that the file 
access being granted is only for writing.

(Other choices for the second argument are <code>"read"</code>,
<code>"delete"</code>, and <code>"execute"</code>.)  </blockquote>
<h3>Signing Extensions</h3>
<blockquote>
You can use the policy file to place additional restrictions on 
the permissions granted to extensions by requiring them to be signed 
by a trusted entity.
(For a review of signing and verifying JAR files, 
see the 
<a class="TutorialLink" target="_top" href="../../deployment/jar/signing.html">Signing JAR Files</a> lesson in this tutorial.)
<p>
To allow signature verification of extensions or other software in 
conjunction with granting permissions, the 
policy file must contain a <em>keystore entry</em>. The keystore entry 
specifies which keystore is to be used in the verification.  Keystore entries 
have the form
<blockquote><pre>
keystore "<i>keystore_url</i>";
</pre></blockquote>
The URL <em>keystore_url</em> is either an absolute or relative. If it's 
relative, the URL is relative to the location of 
the policy file.
For example, to use the default keystore used by <tt>keytool</tt>, add this
entry to <tt>java.policy</tt>

<blockquote><pre>
keystore "file://${user.home}/.keystore";
</pre></blockquote>

<p>
To indicate that an extension must be signed in order to be granted 
security privileges, you use the <code>signedBy</code> field. For example, 
the following entry indicates that the extension <code>area.jar</code> is 
to be granted the listed privileges only if it is signed by the users identified 
in the keystore by the aliases Robert and Rita:
<blockquote><pre>
grant signedBy "Robert,Rita",
    codeBase "file:${java.home}/lib/ext/area.jar" {
        permission java.io.PropertyPermission "user.home", "read";
        permission java.io.FilePermission "${user.home}${/}test${/}*", "write";
};
</pre></blockquote>
If the <code>codeBase</code> field is omitted, as in the following "grant", 
the permissions are granted to <em>any</em> software, including 
installed or download extensions, that are signed by "Robert" or "Rita":
<blockquote><pre>
grant signedBy "Robert,Rita" {
    permission java.io.FilePermission "*", "write";  
};
</pre></blockquote>

<p>
For further details about the policy file format, see section 3.3.1 of 
the 
<a class="OutsideLink" target="_blank" href="http://java.sun.com/javase/6/docs/guide/security/spec/security-spec.doc3.html#20131">Security Architecture Specification</a>  in the JDK documentation.


        </blockquote>
        <div class=NavBit>
            <a target=_top href=index.html>&laquo; Previous</a>
            &bull;
            <a target=_top href=../TOC.html>Trail</a>
            &bull;
            <a target=_top href=sealing.html>Next &raquo;</a>
        </div>
    </div>
    <div id=Footer>
<div id=TagNotes>
    Problems with the examples? Try <a target="_blank"
        href=../../information/run-examples.html>Compiling and Running
        the Examples: FAQs</a>.
    <br>
    Complaints? Compliments? Suggestions? <a target="_blank"
        href="http://developer.sun.com/contact/tutorial_feedback.jsp">Give
    us your feedback</a>.
<br><br>
    <a target="_blank" href="../../information/copyright.html">Copyright</a>
    1995-2007 Sun Microsystems, Inc.  All rights reserved.
    <span id=Download>
</span></div> 

    </div>
    <div class=PrintHeaders>
        <b>Previous page:</b> Making Extensions Secure
        <br><b>Next page:</b> Sealing Packages in Extensions
    </div>
    </body>
</html> 
