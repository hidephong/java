define(["jquery","handlebars","jquery-migrate","ud.package.default","ud.assessment","ud.multiplechoicequestionformitem"],function(e,t){e.widget("ud.ud_assessments_multiple_choice",e.ud.ud_assessment,{options:{instructorMode:!1,studentMode:!1,editMode:!1,type:"multiple-choice",typeReadable:"Multiple Choice"},form:null,_create:function(){e.ud.ud_assessment.prototype._create.apply(this);if(this.options.studentMode||this.options.editMode){var t=this.options.prompt;this.question=t.question,this.answers=t.answers,this.answerElements={}}else if(this.options.instructorMode){var t=this.options.prompt;this.question=t.question,this.answers=t.answers,this.answerElements={}}this._initHandlebarsTemplates()},_initHandlebarsTemplates:function(){t.registerPartial("assessmentActionButtonTemplate",e("#assessmentActionButtonTemplate").html()),this.assessmentMultipleChoiceTemplate=t.compile(e("#assessmentMultipleChoiceTemplate").html()),this.assessmentMultipleChoiceEditorTemplate=t.compile(e("#assessmentMultipleChoiceEditorTemplate").html()),this.editorTemplate=this.assessmentMultipleChoiceEditorTemplate},_init:function(){},__rendered:!1,_render:function(){if(this.__rendered)return;this.element.html(this.assessmentMultipleChoiceTemplate({question:this.question,answers:this.answers,isLastAssessment:this.isLastAssessment,response:this.response,studentMode:this.options.studentMode})),this.submitAnswerBtn=e(".submit-answer-btn",this.element),this.nextBtn=e(".next-btn",this.element),this.finalizeBtn=e(".finalize-btn",this.element),this.mapLetters(),this.applyUserResponse(),this.registerListeners(),this.__rendered=!0},_renderEditor:function(t){typeof t!="undefined"?(this.element.html(this.editorTemplate({})),this.element.ud_initialize({onComplete:function(){this.form=e("form",this.element),this.form.submit(this.editorFormOnSubmit.context(this));var n=t.prompt_json.answers,r=this.getMultipleChoiceQuestionFormItemWidget();r.removeEmptyInputTexts();for(var i in n)r.addChoice(n[i]);r.addInputText(),this.mapEditorLetters(),this.applyInstructorCorrectResponse()}.context(this)})):(this.element.html(this.editorTemplate({})),this.element.ud_initialize({onComplete:function(){this.form=e("form",this.element),this.form.submit(this.editorFormOnSubmit.context(this))}.context(this)}))},_renderEditEditor:function(){},_getCorrectResponseLetter:function(){var t=e("input[type=radio]",this.form),n=e("input[type=radio]:checked",this.form),r=null;if(n.length>0){var i=t.index(n),s="a".charCodeAt(0);r=String.fromCharCode(s+i)}return r},_letterToIndex:function(e){return e.charCodeAt(0)-"a".charCodeAt(0)},editorFormOnSubmit:function(t){t&&t.preventDefault();var n=this.getMultipleChoiceQuestionFormItemWidget();n.updateChoices();var r=this.form.serializeObject(),i=e.parseJSON(r.answers).items;if(e.isEmptyObject(i))return!1;var s=this._getCorrectResponseLetter();if(s){r.correctResponse=JSON.stringify([s]);var o=this._letterToIndex(s);if(!n.getChoiceContent(o))return this.options.editMode&&window.alert("Correct answer cannot be empty!"),!1;this.options.editMode?(r.assessmentId=this.assessmentId,e(this).trigger("assessmentedited",[r,this.assessmentEditedHandler.context(this)])):e(this).trigger("assessmentcreated",[r,this.assessmentCreatedHandler.context(this)])}else window.alert("Please choose the correct answer.")},assessmentCreatedHandler:function(e){this.element.remove()},assessmentEditedHandler:function(e){},mapLetters:function(){var t="a".charCodeAt(0);e("ul.answers li",this.element).each(function(e,n){var r=String.fromCharCode(t+e);this.answerElements[r]=n}.context(this))},mapEditorLetters:function(){var t="a".charCodeAt(0);e("ul#choices-list-answers li",this.element).each(function(e,n){var r=String.fromCharCode(t+e);this.answerElements[r]=n}.context(this))},applyUserResponse:function(){if(this.options.instructorMode)return;if(this.response===undefined||this.response===null)return!1;var t=this.answerElements[this.response[0]],n=this.answerElements[this.correctResponse[0]];return e.each(this.answerElements,function(t,n){e(n).removeClass("selected")}),t==n?e(t).addClass("correct"):(e(t).addClass("wrong"),e(n).addClass("correct")),!0},applyInstructorCorrectResponse:function(){e.each(this.answerElements,function(t,n){e("input[type=radio]",e(n)).removeAttr("checked")});var t=this.answerElements[this.correctResponse[0]];e("input[type=radio]",t).attr("checked","checked");var n=e("textarea",this.element);n.data("ud-ud_wysiwyg").setValue(this.question)},registerListeners:function(){if(this.options.instructorMode){this.nextBtn.on("click",this.assessmentDoneHandler.context(this)),e(".view-results-btn",this.element).on("click",this.assessmentDoneHandler.context(this));return}this.nextBtn.on("click",this.assessmentDoneHandler.context(this)),this.finalizeBtn.on("click",this.assessmentDoneHandler.context(this));if(this.response)return;e.each(this.answerElements,function(t,n){e(n).click(function(){this.answerClickHandler([t])}.context(this))}.context(this)),this.submitAnswerBtn.on("click",this.submitAnswerHandler.context(this))},deregisterListeners:function(){e.each(this.answerElements,function(t,n){e(n).unbind("click")}.context(this)),this.submitAnswerBtn.off("click")},answerClickHandler:function(t){this.responseToSubmit=t;var n=this.answerElements[this.responseToSubmit[0]];e.each(this.answerElements,function(t,n){e(n).removeClass("selected")}),e(n).addClass("selected")},answerResultsHandler:function(t,n){this.correctResponse=n;var r=this.applyUserResponse();r&&(this.deregisterListeners(),e(this.submitAnswerBtn).remove(),this.isLastAssessment?e(this.finalizeBtn).removeClass("none"):e(this.nextBtn).removeClass("none"))},submitAnswerHandler:function(t){t&&t.preventDefault(),t&&t.stopPropagation(),this.response=this.responseToSubmit,e(this).trigger("answer",[this.response,this.answerResultsHandler.context(this)])},assessmentDoneHandler:function(t){t&&t.preventDefault(),t&&t.stopPropagation(),e(this).trigger("assessmentdone")},getMultipleChoiceQuestionFormItemWidget:function(){var t=e(".ud-multiplechoicequestionformitem",this.element);return t.data("ud-ud_multiplechoicequestionformitem")}})});