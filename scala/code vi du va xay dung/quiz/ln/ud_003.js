define(["jquery","handlebars","jquery-migrate","ud.package.default"],function(e,t){e.widget("ud.ud_userlist",{options:{sourceUrl:null,pageSize:null,autoLoad:!1,showProgress:!1,progressUrl:null,searchEnabled:!1},currentPage:0,searchQuery:null,userTemplate:null,searchByNameForm:null,extendedHandlebarsHelpers:null,_create:function(){e.extend(this.options,this.element.data()),this._initHandlebarsTemplates(),this._defineLocalHandlebarsHelpers(),this._initUI(),e(this.element).on("click",".more a",e.proxy(this._loadMoreUsers,this)),e(this.element).on("click",".follow",e.proxy(this._followUser,this)),e(this.element).on("click",".following",e.proxy(this._unfollowUser,this)),this.searchQueryInput=e(".search-input",this.element),this.element.on("input keyup",".search-input",e.debounce(250,e.proxy(this._searchUsersByName,this))),this.options.autoLoad&&this.load()},_destroy:function(){},_initHandlebarsTemplates:function(){this.userTemplate=t.compile(e("#courseStudentTemplate").html()),this.courseStudentListTemplate=t.compile(e("#courseStudentListTemplate").html())},_initUI:function(){this.element.html(this.courseStudentListTemplate({searchEnabled:this.options.searchEnabled}))},_defineLocalHandlebarsHelpers:function(){if(this.extendedHandlebarsHelpers===null){var n={generateMessageUrl:function(t){return UD.Config.link("message","",{action:"send-new",userId:e.trim(t)})}};this.extendedHandlebarsHelpers=e.extend({},t.helpers,n)}},_searchUsersByName:function(t){var n=this.searchQuery;this.searchQuery=e.trim(this.searchQueryInput.val()),n!=this.searchQuery&&(this.currentPage=0,this._loadUsers())},_loadMoreUsers:function(e){e.preventDefault(),this._loadUsers()},_followUser:function(t){t.preventDefault();var n=e(t.currentTarget);UD.API.call("/users/me/follow/"+n.data("userid"),{success:e.proxy(this._followUserSuccessHandler,this,n)})},_unfollowUser:function(t){t.preventDefault();var n=e(t.currentTarget);UD.API.call("/users/me/unfollow/"+n.data("userid"),{success:e.proxy(this._unfollowUserSuccessHandler,this,n)})},_followUserSuccessHandler:function(e,t){t&&e.removeClass("follow blue").addClass("following green").text("Following")},_unfollowUserSuccessHandler:function(e,t){t&&e.removeClass("following green").addClass("follow blue").text("Follow")},load:function(){this.currentPage===0&&this._loadUsers()},_loadUsers:function(){e(".more .btn",this.element).addClass("none"),e(".ajax-loader-tiny",this.element).show();var t={p:++this.currentPage,pageSize:this.options.pageSize};this.searchQuery&&(t.q=this.searchQuery),UD.API.call(this.options.sourceUrl,{type:"GET",data:t,success:e.proxy(this._loadUsersSuccessHandler,this)})},_loadUsersSuccessHandler:function(t){e(".ajax-loader-tiny",this.element).hide(),t.show_progress=this.options.showProgress;for(var n=0;n<t.data.length;n++)t.data[n].show_buttons=t.data[n].id!==UD.me.id;if(this.options.showProgress){var r=t.data.map(function(e){return e.id});r.length>0&&this._loadUserCompletionRates(r)}this.currentPage==1?e(".users-container",this.element).html(this.userTemplate(t,{helpers:this.extendedHandlebarsHelpers})):e(".users-container",this.element).append(this.userTemplate(t,{helpers:this.extendedHandlebarsHelpers}));var i=t.pagination;Number(i.page_size)*Number(i.page)<Number(i.total)&&e(".more .btn",this.element).removeClass("none"),this.element.ud_initialize(),typeof e.fancybox!="undefined"&&e.fancybox.reposition()},_loadUserCompletionRates:function(t){UD.API.call(this.options.progressUrl,{type:"GET",data:{userIds:t.join(",")},success:e.proxy(this._loadUserCompletionRatesSuccessHandler,this)})},_loadUserCompletionRatesSuccessHandler:function(t){for(var n=0;n<t.length;n++){var r=e("li[data-userid='"+t[n].user_id+"'] .progress .bar",this.element),i=Math.ceil(t[n].completion_rate)+"%";r.html(i).css("width",i)}}})});