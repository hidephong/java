define(["jquery","handlebars","jquery-migrate","ud.package.default","ud.assessment","ud.assessments.fill-in-the-blanks","ud.assessments.multiple-choice","ud.assessments.true-false"],function(e,t){e.widget("ud.ud_quiz",{options:{quizId:null,autoLoad:!0,studentMode:!1,instructorMode:!1,instructorPreviewMode:null,viewFinalPage:!1},quiz:null,position:null,quizNavigation:null,quizViewer:null,quizCompletedTimeout:null,_create:function(){for(var e in this.options)typeof this.element.data(e.toLowerCase())!="undefined"&&(this.options[e]=this.element.data(e.toLowerCase()));this.options.autoLoad&&(this.load(),this.loaded=!0),this.assessmentElements=null,this.position=0,this._initHandlebarsTemplates()},_initHandlebarsTemplates:function(){this.assessmentTemplate=t.compile(e("#assessmentTemplate").html()),this.quizFinalResultsTemplate=t.compile(e("#quizFinalResultsTemplate").html()),this.quizInstructorFinalResultsTemplate=t.compile(e("#quizInstructorFinalResultsTemplate").html()),this.quizStartPageTemplate=t.compile(e("#quizStartPageTemplate").html()),t.registerHelper("isAnswerCorrect",function(e,t){var n=t.fn,r=t.inverse;return e==="1"?n(this):r(this)})},_initializeQuiz:function(t){this.quiz=t,this.quiz.is_instructor=this.options.instructorMode,this.numOfAssessments=parseInt(this.quiz.assessment_count),this.quizViewer=e("ul.quiz-viewer",this.element),this.quizNavigation=e(".quiz-navigation",this.element),this.quizNavigationBackBtn=e(".back-btn2",this.quizNavigation),this.quizViewer.append(this.quizStartPageTemplate(this.quiz)),this.startQuizBtn=e(".start-page .start-btn",this.quizViewer),this.startQuizBtn.on("click",this._startQuiz.context(this)),this.viewResultsBtn=e(".start-page .view-results-btn",this.quizViewer),this.viewResultsBtn.on("click",this.showResults.context(this)),this.resetAnswersBtn=e(".start-page .reset-answers-btn",this.quizViewer),this.resetAnswersBtn.on("click",this.resetAnswers.context(this)),this.quizNavigationBackBtn.on("click",this.goToResultsPage.context(this)),this.registerQuizListeners()},quizCompleteHandler:function(t,n){t&&t.preventDefault(),UD.API.call("/quizzes/"+this.options.quizId+"/complete",{type:"POST",success:function(t){e.event.trigger("quizProgressChanged",[this.options.quizId]),this.createFinalResultsPage()}.context(this)})},quizDownloadHandler:function(t,n){UD.API.call("/quizzes/"+this.options.quizId+"/downloaded",{type:"POST",async:!1,success:function(t){t.is_completed&&e.event.trigger("quizDownloaded_"+this.options.quizId)}.context(this)})},quizProgressHandler:function(t,n){UD.API.call("/quizzes/"+this.options.quizId+"/progress",{type:"POST",data:{data:Base64.encode(JSON.stringify(n))},success:function(t){t.is_completed&&e.event.trigger("quizCompleted_"+this.options.quizId)}.context(this)})},sendProgressData:function(){e.event.trigger("quizProgress_"+this.options.quizId,{position:1,total:1})},unload:function(){this.element.html(""),clearTimeout(this.quizCompletedTimeout)},load:function(){if(this._loaded)return;this._loaded=!0;var t=arguments.length>=1?arguments[0]:null;this._getAnalyticsTrackingCode(),UD.API.call("/quizzes/"+this.options.quizId+"/assessments?includeUserResponse",{type:"GET",success:function(n){var r=this.getAssessmentListWithUserResponse(n),i=r.length,s=this.assessmentTemplate({assessments:r});e(".start-page",this.quizViewer).after(s),e.each(r,function(e,t){e==i-1?t.isLastAssessment=!0:t.isLastAssessment=!1;var n=this.createAssessmentViewWidget(t);n.render()}.context(this)),t&&t(n)}.context(this)})},getAssessmentListWithUserResponse:function(t){var n=t.assessment_list,r=t.user_response_list;return e.each(n,function(e,t){var n=t.id;typeof r[n]!="undefined"?t.user_response=r[n]:t.user_response=null}),n},createAssessmentViewWidget:function(t){var n=null,r={};r.assessmentId=t.id,r.prompt=t.prompt_json,r.correctResponse=t.correct_response_json,r.isLastAssessment=t.isLastAssessment,r.studentMode=this.options.studentMode,r.instructorMode=this.options.instructorMode,t.user_response&&(r.response=t.user_response.response_json);var i=e("#quiz-assessment-"+t.id,this.element);switch(t.type){case"multiple-choice":require(["ud.assessments.multiple-choice"],function(){}.context(this)),i.ud_assessments_multiple_choice(r),n=i.data("ud-ud_assessments_multiple_choice");break;case"fill-in-the-blanks":i.ud_assessments_fill_in_the_blanks(r),n=i.data("ud-ud_assessments_fill_in_the_blanks");break;case"true-false":i.ud_assessments_true_false(r),n=i.data("ud-ud_assessments_true_false")}return this.registerAssessmentListeners(n),n},createFinalResultsPage:function(t){UD.API.call("/quizzes/"+this.options.quizId+"/stats",{type:"GET",success:function(t){t.me=UD.me,this.options.instructorMode?this.quizViewer.append(this.quizInstructorFinalResultsTemplate(t)):this.quizViewer.append(this.quizFinalResultsTemplate(t)),this.options.viewFinalPage=!0,this.resultsPage=e(".results-page",this.quizViewer),e(".scoreboard li.q",this.resultsPage).on("click",this.resultsPageQuestionOnClick.context(this))}.context(this)})},resultsPageQuestionOnClick:function(t){var n=e(t.currentTarget).data("position");this.goToQuestion(n)},registerAssessmentListeners:function(t){e(t).bind("answer",this.answerHandler.context(this)),e(t).bind("assessmentdone",this.assessmentDoneHandler.context(this))},answerHandler:function(e,t,n){var r=e.currentTarget;UD.API.call("/quizzes/"+this.options.quizId+"/assessments/"+r.assessmentId+"/answers/",{type:"POST",data:{duration:0,response:t},success:function(e){var t=e.score,r=e.correct_response;n&&n(t,r)}.context(this)})},assessmentDoneHandler:function(e){this.position===this.numOfAssessments?(this.options.instructorMode||this.quizCompleteHandler(),this.showResults()):this.goToQuestion(this._getPosition()+1)},showResults:function(e){e&&e.preventDefault(),this.goToResultsPage(),this.createFinalResultsPage()},resetAnswers:function(t){t&&t.preventDefault(),UD.API.call("/quizzes/"+this.options.quizId+"/reset",{type:"POST",success:function(t){e.event.trigger("quizProgressChanged",[this.options.quizId]),this.element.trigger("quizResetted",{quizId:this.options.quizId})}.context(this)})},markAsViewed:function(){},setPositionHandler:function(){},_getPosition:function(){return this.position},_setPosition:function(e){this.position=e},getTotal:function(){return this.total},renderPosition:function(e){return null},_renderTime:function(e){return""},_renderPage:function(e){return e>=0?"Page "+e:""},registerQuizListeners:function(){e(".quiz-navigation .ddown ul a",this.element).live("click",function(t){t.preventDefault(),t.stopPropagation();var n=e(t.currentTarget),r=parseInt(e(".num",n).html()),i=n.parents(".ddown").eq(0);e("> a .current",i).text(r),i.removeClass("on"),this.goToQuestion(r)}.context(this)),this.element.bind("quizCompleted_"+this.options.quizId,this.quizCompleteHandler.context(this)),this.element.bind("quizDownloaded_"+this.options.quizId,this.quizDownloadHandler.context(this)),this.element.bind("quizProgress_"+this.options.quizId,this.quizProgressHandler.context(this))},goToQuestion:function(t,n){n&&n.preventDefault(),this._setPosition(t),t==0?this.quizNavigation.addClass("none"):this.quizNavigation.removeClass("none"),this.options.viewFinalPage?this.quizNavigationBackBtn.removeClass("none"):this.quizNavigationBackBtn.addClass("none"),e(".ddown > a .current",this.quizNavigation).text(t);var r=-100*t+"%";this.quizViewer.css("left",r)},_startQuiz:function(e){e&&e.preventDefault(),this.goToQuestion(1),this.quizNavigation.removeClass("none")},goToResultsPage:function(e){e&&e.preventDefault();var t=this.numOfAssessments+1;this.quizNavigation.addClass("none");var n=-100*t+"%";this.quizViewer.css("left",n)},_getAnalyticsTrackingCode:function(){UD.API.call("/quizzes/"+this.options.quizId+"/tracking-code",{success:function(e){this.element.append(e.code)}.context(this)})}})});